/*
 * Nanomaps JavaScript Library
 * https://github.com/stellaeof/nanomaps
 * Copyright 2011, Stella Laurenzo
 * Licensed under the MIT open source license
 * Date: Thu May 26 2011 16:40:26 GMT-0700 (PDT)
 */
(function(c){var ae={};c.nanomaps=ae;function R(){return function(){}}function l(av){if(Object.create){return Object.create(av)}var aw;if(av){aw=R();aw.prototype=av;return new aw()}return{}}function j(av,aw){var ax=l(aw.prototype);ah(av.prototype,ax);av.prototype=ax}function ah(ax,av){av=av||{};if(ax){for(var aw in ax){if(ax.hasOwnProperty(aw)){av[aw]=ax[aw]}}}return av}ae.ObjectCreate=l;ae.ObjectCopy=ah;ae.inherits=j;function E(){}var G=E.prototype={};G._evt=G.listeners=function(aw){var ax=this.__evt,av;if(!ax){this.__evt=ax={}}av=ax[aw];if(!av){av=ax[aw]=[]}return av};G.addListener=G.on=function(aw,av){this._evt(aw).push(av)};G.once=function(aw,av){this._evt(aw+"$once").push(av)};G.removeListener=function(av,ax){aw(this._evt(av));aw(this._evt(av+"$once"));function aw(ay){for(var az=ay.length-1;az>=0;az--){if(ay[az]===ax){ay.splice(az,1)}}}};G.removeAllListeners=function(av){this._evt(av).length=0;this._evt(av+"$once").length=0};G.emit=function(ay){var av,ax,aw=Array.prototype.slice.call(arguments,1),az=this["on"+ay];if(typeof az==="function"){az.apply(this,aw)}ax=this._evt(ay+"$once");for(av=0;av<ax.length;av++){ax[av].apply(this,aw)}ax.length=0;ax=this._evt(ay);for(av=0;av<ax.length;av++){ax[av].apply(this,aw)}};G.advise=function(av,aA,ax){var ay=this[av],aw,az;if(!ay||!ay.__stub__||!this.hasOwnProperty(av)){aw=this[av]=ag(ay)}else{aw=ay}az=aw[aA];if(az){az.push(ax)}};function ag(av){var aw=function(){var aA,ay=arguments.callee,az,ax;az=ay.before;for(aA=0;aA<az.length;aA++){az[aA].apply(this,arguments)}if(av){ax=av.apply(this,arguments)}az=ay.after;for(aA=0;aA<az.length;aA++){az[aA].apply(this,arguments)}};aw.__stub__=true;aw.before=[];aw.after=[];return aw}function ab(){return new Date().getTime()}function F(av){return typeof av==="function"}function C(av){throw new Error("Object "+av+" is not a DOM element")}ae.EventEmitter=E;var L=!!window.addEventListener;function H(aw,av){if(aw.currentStyle){return aw.currentStyle[av]}else{if(window.getComputedStyle){return aw.ownerDocument.defaultView.getComputedStyle(aw,"").getPropertyValue(av)}}return""}function al(av){var aw=H(av,"position");return aw==="relative"||aw==="absolute"||aw==="fixed"}function o(av){return window.HTMLElement?av instanceof HTMLElement:(av.nodeType===1)}function au(ax,aw,av){ax.addEventListener(aw,av,false)}function k(ax,aw,av){ax.removeEventListener(aw,av,false)}function Q(av){if(L){return av.button===0}else{return av.button===1}}function aj(av){if(av.stopPropagation){av.preventDefault();av.stopPropagation()}else{av.cancelBubble=true;av.returnValue=false}}var y=["x","lng","longitude","lon"],B=["y","lat","latitude"];function w(av,ax){var ay,aw,az;for(ay=0;ay<ax.length;ay++){aw=av[ax[ay]];if(aw!==undefined&&aw!==null){az=typeof aw;if(az==="number"){return aw}else{if(az==="function"){return Number(aw.call(av))}}}}return NaN}function d(aw,av){this._x=Number(aw);this._y=Number(av)}d.latLng=function(av,aw){return new d(aw,av)};d.xy=function(aw,av){return new d(aw,av)};d.from=function(av){if(av instanceof d){return av}if(av instanceof Array){return new d(av[0],av[1])}var aw=w(av,y),ax=w(av,B);return new d(aw,ax)};d.prototype={x:function(){return this._x},y:function(){return this._y},lat:function(){return this._y},lng:function(){return this._x}};ae.Coordinate=d;function h(av,aw,ax,ay){this.minx=av;this.miny=aw;this.maxx=ax;this.maxy=ay}function N(ay,aA,ax){var aB,aw,az,av="";for(aB=ax;aB>0;aB--){az=48;aw=1<<(aB-1);if((ay&aw)!==0){az++}if((aA&aw)!==0){az+=2}av+=String.fromCharCode(az)}return av}var at={WebMercator:function(aA){if(!aA){aA={}}this.DEFAULT_CENTER={lat:39.7406,lng:-104.985441};this.DEFAULT_RESOLUTION=611.4962;this.XINVERTED=false;this.YINVERTED=true;var aB=6378137,aC=0.017453292519943295,av=57.29577951308232,ax=0.7853981633974483,az=1.5707963267948966,ay=78271.517;this.MIN_LEVEL=aA.MIN_LEVEL||1;this.MAX_LEVEL=aA.MAX_LEVEL||18;this.fwdX=function(aD){return aD*aC*aB};this.fwdY=function(aD){return Math.log(Math.tan(ax+0.5*aC*aD))*aB};this.invX=function(aD){return av*aD/aB};this.invY=function(aD){return av*(az-2*Math.atan(Math.exp(-aD/aB)))};this.fromLevel=function(aD){return ay/Math.pow(2,aD-1)};this.toLevel=function(aD){return Math.log(ay/aD)/Math.log(2)+1};var aw=this.GLB_EXTENT=new h(-180,-85.05112878,180,85.05112878);this.PRJ_EXTENT=new h(this.fwdX(aw.minx),this.fwdY(aw.miny),this.fwdX(aw.maxx),this.fwdY(aw.maxy));aA=null}};ae.Projections=at;function z(aC,aw,aD,ax){var aA=3*aC,ay=3*(aD-aC)-aA,aE=1-aA-ay,aB=3*aw,az=3*(ax-aw)-aB,av=1-aB-az;return function(aG,aI){if(!aI){aI=[]}var aF=aG*aG,aH=aF*aG;aI[0]=aE*aH+ay*aF+aA*aG;aI[1]=av*aH+az*aF+aB*aG;return aI}}var x={curve:z(0.25,0.25,0.25,0.25),duration:0.5,rate:10};function I(av,aw){if(!aw){aw=x}this._f=av;this._c=aw.curve||x.curve;this._d=aw.duration||x.duration;this._r=aw.rate||x.rate;this._s=0}I.prototype={start:function(){if(this._s!==0){return}var av=this,ax,aw;av._ts=ab();av._td=av._d*1000;av._te=av._ts+av._td;av._tn=0;ax=av._d*av._r;aw=(av._te-av._ts)/ax;if(aw<=0){av._s=2;av._f(0,[0,0],true)}else{av._s=1;av._ii=setInterval(function(){av._frame()},aw);av._frame()}},finish:function(){this._last()},interrupt:function(){var aw=this,av=aw._ii;if(aw._s===2){return}if(av){clearInterval(av)}aw._s=2},_frame:function(){var aw=this,ax=ab(),av=(ax-aw._ts)/aw._td,ay;if(av>=1||av<0||isNaN(av)){aw._final();return}ay=aw._c(av);aw._f(++aw._tn,ay,false)},_final:function(){var aw=this,av=aw._ii;if(aw._s===2){return}if(av){clearInterval(av)}aw._s=2;aw._f(aw._tn,[1,1],true);aw._f=null}};ae.MakeBezierCurve=z;ae.Animation=I;function af(av){if(av){av.copy(this)}else{this.prj=null;this.res=1;this.x=0;this.y=0;this.w=0;this.h=0}this.finalState=null}af.prototype={compare:function(aw){var av=0;if(this.x!==aw.x||this.y!==aw.y||this.w!==aw.w||this.h!==aw.h){av=1}if(this.prj!==aw.prj||this.res!==aw.res){av=2}return av},copy:function(av){av.x=this.x;av.y=this.y;av.w=this.w;av.h=this.h;av.prj=this.prj;av.res=this.res},getZoom:function(){return this.prj.toLevel(this.res)},getDspX:function(aw,av){return this.x+aw},getDspY:function(aw,av){return this.y+av},getPrjX:function(aw,ax){var av=this.prj,ay=this.getDspX(aw,ax)*this.res;if(av.XINVERTED){ay=av.PRJ_EXTENT.maxx-ay}return ay},getPrjY:function(aw,ax){var av=this.prj,ay=this.getDspY(aw,ax)*this.res;if(av.YINVERTED){ay=av.PRJ_EXTENT.maxy-ay}return ay},getGlbX:function(aw,av){return this.prj.invX(this.getPrjX(aw,av))},getGlbY:function(aw,av){return this.prj.invY(this.getPrjY(aw,av))},prjToDspX:function(aw){var av=this.prj;if(av.XINVERTED){aw=av.PRJ_EXTENT.maxx-aw}return aw/this.res},prjToDspY:function(aw){var av=this.prj;if(av.YINVERTED){aw=av.PRJ_EXTENT.maxy-aw}return aw/this.res},setRes:function(ay,aw,ax){if(ay!==this.res){var az=this.getPrjX(aw,ax),av=this.getPrjY(aw,ax);this.res=ay;this.setPrjXY(az,av,aw,ax)}},setZoom:function(ax,aw,av){this.setRes(this.prj.fromLevel(ax),aw,av)},setDspXY:function(ay,av,aw,ax){this.x=ay-aw;this.y=av-ax},setPrjXY:function(ay,av,aw,ax){this.setDspXY(this.prjToDspX(ay),this.prjToDspY(av),aw,ax)},setGlbXY:function(ay,az,aw,ax){var av=this.prj;this.setPrjXY(av.fwdX(ay),av.fwdY(az),aw,ax)}};function Y(aC,av){if(!av){av={}}var ay=av.document||aC.ownerDocument||window.document,aE=av.width,ax=av.height,az,aw,aB,aA;function aD(aF){return ay.createElement(aF)}this.createElement=aD;this._layers=[];this._surfaces=[];aC.nmt="parent";aC.style.overflow="hidden";if(!al(aC)){aC.style.position="relative"}this.elements={document:ay,parent:aC};aw=this.layer(v.EVENT);aw.style.position="absolute";aw.style.left="0px";aw.style.top="0px";aw.style.width="100%";aw.style.height="100%";this.elements.event=aw;this.mapState=aB=new af();aB.prj=av.projection||new at.WebMercator();aB.res=av.resolution||aB.prj.DEFAULT_RESOLUTION;this._zoomBias=av.zoomBias||0;this._pendMapState=new af(aB);this._pendLock=0;this._pendAnim=null;if(typeof aE!=="number"||typeof ax!=="number"){this.setSize();aE=aC.clientWidth;ax=aC.clientHeight}else{this.setSize(aE,ax)}this.initialize(av);this.collect()}var X=Y.prototype=new E();function am(av,aw){return(aw===undefined||aw===null)?av.mapState.w/2:Number(aw)}function ak(aw,av){return(av===undefined||av===null)?aw.mapState.h/2:Number(av)}function p(av,ax){var aw=av.mapState.prj;ax=Number(ax);if(isNaN(ax)){ax=aw.MAX_LEVEL}if(ax<aw.MIN_LEVEL){ax=aw.MIN_LEVEL}else{if(ax>aw.MAX_LEVEL){ax=aw.MAX_LEVEL}}return ax}var v={BACKGROUND:0,MAP:10,SHADOW:50,EVENT:100,OVERLAY:1000,FOREGROUND:10000};function ar(av){var aw=v[String(av).toUpperCase()];if(aw===undefined){aw=parseInt(av);if(isNaN(aw)){aw=v.FOREGROUND}}return aw}function s(aE,av,ay){var aA=ay.res-av.res,ax=av.getPrjX(0,0),aC=av.getPrjY(0,0),aD=ay.getPrjX(0,0)-ax,aw=ay.getPrjY(0,0)-aC,az=ay.w-av.w,aB=ay.h-av.h;av=new af(av);ay=new af(ay);updateMapState=new af(av);return function(aI,aG,aJ){var aH=aG[0],aF;if(aJ){updateMapState=ay;aE._pendAnim=null;aE.mapState.finalState=null}else{updateMapState.res=av.res+aH*aA;updateMapState.setPrjXY(ax+aH*aD,aC+aH*aw,0,0);updateMapState.w=av.w+aH*az;updateMapState.h=av.h+aH*aB}aF=updateMapState.compare(aE.mapState);if(aF>0){updateMapState.copy(aE.mapState);aE._invalidate(aF>1)}}}X.begin=function(){return this._pendLock++===0};X.rollback=function(){this.mapState.copy(this._pendMapState);this._pendLock=0};X.commit=function(av){if(this._pendLock<=0||--this._pendLock>0){return false}var aw=this._pendMapState,ay=this.mapState,az;var ax=aw.compare(ay);if(ax>0){if(this._pendAnim){this._pendAnim.interrupt();this._pendAnim=null;ay.finalState=null}if(!av){aw.copy(ay);this._invalidate(ax>1)}else{if(typeof av==="object"){az=av}ay.finalState=new af(aw);this._pendAnim=new I(s(this,ay,aw),az);this._pendAnim.start()}}return true};X.forceCommit=function(){this._pendLock=1;this.commit()};X.layer=function(av){var az=this.elements.parent,ay=this._layers,aA,aB,aw=ar(av),ax,aC;for(aB=0;aB<ay.length;aB++){aA=ay[aB];if(aA.ordinal===aw){return aA}}aA=this.createElement("div");aA.ordinal=aw;aA.nmt="layer";aA.setAttribute("layer",String(aw));aA.style.width="0px";aA.style.height="0px";ay.push(aA);for(aC=az.firstChild;aC;aC=aC.nextSibling){if(aC.nodeType===1&&aC.nmt){ax=aC.ordinal;if(ax!==undefined&&ax>aw){break}}}az.insertBefore(aA,aC);return aA};X.surface=function(aA){var aB=ar(aA),ax=this.mapState,av=this._surfaces,aw,ay,az;for(ay=0;ay<av.length;ay++){aw=av[ay];if(aw.ordinal===aB){return aw}}aw=this.createElement("div");aw.ordinal=aB;aw.nmt="surface";aw.className="managed";aw.style.position="absolute";aw.style.left=(-ax.x)+"px";aw.style.top=(-ax.y)+"px";av.push(aw);az=this.layer(aB);az.insertBefore(aw,az.firstChild);return aw};X.getZoom=function(){return this._pendMapState.getZoom()+this._zoomBias};X.setZoom=function(ax,aw,ay){var av=this._pendMapState,az=av.res;this.begin();ax=p(this,ax-this._zoomBias);av.setZoom(ax,am(this,aw),ak(this,ay));this.commit()};X.zoomIn=function(aw,av){this.setZoom(Math.round(this.getZoom()+1),aw,av)},X.zoomOut=function(aw,av){this.setZoom(Math.round(this.getZoom()-1),aw,av)},X.getLocation=function(aw,ax){var av=this._pendMapState;aw=am(this,aw);ax=ak(this,ax);return d.xy(av.getGlbX(aw,ax),av.getGlbY(ax,ax))};X.setLocation=function(av,aw,ax){av=d.from(av);this.begin();this._pendMapState.setGlbXY(av._x,av._y,am(this,aw),ak(this,ax));this.commit()};X._invalidate=function(ay){var ax=this.mapState,av=this._surfaces,aw,az;for(az=0;az<av.length;az++){aw=av[az];aw.style.left=(-ax.x)+"px";aw.style.top=(-ax.y)+"px"}if(ay){this._notifyReset()}else{this._notifyPosition()}};X._each=function(az,ax){var ay=this._layers,aw=this._surfaces,av,aB,aA;for(aB=0;aB<ay.length;aB++){av=ay[aB];for(var aA=av.firstChild;aA;aA=aA.nextSibling){if(aA.nodeType!==1||aA.nmt==="surface"){continue}ax.call(this,aA)}}if(az){for(aB=0;aB<aw.length;aB++){av=aw[aB];for(var aA=av.firstChild;aA;aA=aA.nextSibling){if(aA.nodeType!==1){continue}ax.call(this,aA)}}}};X._notifyPosition=function(){this._each(false,function(aw){var av=aw.mapeer||W;if(F(av.maposition)){av.maposition(this,aw)}})};X._notifyReset=function(){this._each(true,this._notifyResetSingle)};X._notifyResetSingle=function(aw){var av=aw.mapeer||W;if(F(av.mareset)){av.mareset(this,aw)}};X.initialize=function(av){};X.eventToContainer=function(aA,aw){var av=this.elements[aw||"parent"],ax=av,az={x:aA.clientX,y:aA.clientY},ay;do{ay=parseInt(H(ax,"zoom"))||1;az.x-=ax.offsetLeft;az.y-=ax.offsetTop;az.x/=ay;az.y/=ay}while(ax=ax.offsetParent);az.x+=window.pageXOffset||0;az.y+=window.pageYOffset||0;return az};function n(aw,av){if(o(av)){return av}if(!av||!F(av.getElement)){throw new Error("Object "+av+" is not a valid Attachment")}return av.getElement(aw)}X.attach=function(ax,av){if(!av){av={}}var aw=av.layer,az=av.unmanaged,aA,aB=n(this,ax);if(ax!==aB){if(!aw){aw=ax.defaultLayer}az=ax.unmanaged}aB.style.position="absolute";aA=az?this.layer(aw):this.surface(aw);if(aB.parentNode===aA){return}try{aA.appendChild(aB)}catch(ay){C(aB)}this._notifyResetSingle(aB);return aB};X.detach=function(av){var aw=n(this,av);if(aw.parentNode){aw.parentNode.removeChild(aw)}};X.collect=function(){};X.update=function(ax){var aw=n(this,ax),av=aw.parentNode;if(!av||!av.nmt){this.attach(ax)}else{this._notifyResetSingle(aw)}return aw};X.setSize=function(ax,av){var az=this.elements.parent,aw=this.getLocation(),ay=this._pendMapState;this.begin();if(arguments.length<2){az.style.width="";az.style.height="";ax=az.clientWidth;av=az.clientHeight}az.style.width=ax+"px";az.style.height=av+"px";ay.w=ax;ay.h=av;this.setLocation(aw);this.commit()};X.moveBy=function(ax,av){var aw=this.getLocation(ax,-av);this.setLocation(aw,0,0)};X.globalToXY=function(ay){var az=this.mapState,av=az.prj,aw,ax;ay=d.from(ay);aw=az.prjToDspX(av.fwdX(ay._x));ax=az.prjToDspY(av.fwdY(ay._y));return(isNaN(aw)||isNaN(ax))?null:new d(aw,ax)};function T(aw){var av=aw.geo;if(!av){av={};if(isNaN(av.latitude=Number(aw.getAttribute("latitude")||"NaN"))){return null}if(isNaN(av.longitude=Number(aw.getAttribute("longitude")||"NaN"))){return null}av.xoffset=Number(aw.getAttribute("xoffset")||"NaN");av.yoffset=Number(aw.getAttribute("yoffset")||"NaN")}return av}var W={defaultLayer:"overlay",mareset:function(ay,av){var az=T(av),aA,aw,ax;if(az){aA=ay.globalToXY(az);if(aA){aw=aA.x()+Number(az.xoffset||0);ax=aA.y()+Number(az.yoffset||0);av.style.left=(aw)+"px";av.style.top=(ax)+"px";av.style.display="block";return}}av.style.display="none"}};ae.MapSurface=Y;ae.DefaultAttachmentPeer=W;function r(aw){if(!aw){aw={}}var ax=this.peer=new Z();var ay=ax.sel=new e(aw);var av=this.element=document.createElement("div");av.style.position="absolute";av.style.left="0px";av.style.top="0px";av.mapeer=ax;av.setAttribute("tilesrc",ay.toString())}r.prototype={unmanaged:true,defaultLayer:"map",getElement:function(av){this.owner=av;return this.element}};function Z(){this.lockedState=null;this.current=new P();this.old=new P();this.transition=new P()}Z.prototype={maposition:function(av,aw){this.mareset(av,aw)},loadPendingTiles:function(aC){var ax=this.transition,aB=this.current,aw=aC.w-1,aE=aC.h-1,ay,aA,av,az,aD=[];ax.clear();ay=this.sel.select(aC.prj,aC.res,aC.getPrjX(0,0),aC.getPrjY(0,0),aC.getPrjX(aw,aE),aC.getPrjY(aw,aE));for(aA=0;aA<ay.length;aA++){av=ay[aA];az=aB.move(av,ax);if(!az){az=new b(this.sel,av);ax.add(az);aD.push(az);U(aC,az)}}u(aD,aC.w/2,aC.h/2);for(aA=0;aA<aD.length;aA++){az=aD[aA];az.loading=true;this.sel.loadTile(az,null,true)}},mareset:function(aH,aA){var aC=this.current,ax=this.transition,aF=this.old,aE=aH.mapState,aD=this.lockedState,av=aE.w-1,aI=aE.h-1,ay,aB,aw,az,aG=[];if(aD!==aE.finalState){aD=this.lockedState=aE.finalState;if(aD){this.loadPendingTiles(aD)}}aC.resetMarks();ay=this.sel.select(aE.prj,aE.res,aE.getPrjX(0,0),aE.getPrjY(0,0),aE.getPrjX(av,aI),aE.getPrjY(av,aI));for(aB=0;aB<ay.length;aB++){aw=ay[aB];az=aC.get(aw)||ax.move(aw,aC);if(!aD&&az&&az.temporary){az=null}if(!az){az=new b(this.sel,aw);if(aD){az.temporary=true}aC.add(az)}az.mark=true;U(aE,az);if(!az.parent){aG.push(az)}}if(aG.length>0){aC.sweep(aF,function(aJ){U(aE,aJ)})}u(aG,aE.w/2,aE.h/2);for(aB=0;aB<aG.length;aB++){az=aG[aB];if(!az.loading&&!az.temporary){az.loading=true;this.sel.loadTile(az)}if(!az.drawable){az.generatePreview(aF)}az.attach(aA)}aC.sweep();aF.sweep();if(!aD){ax.clear()}}};function u(av,aw,ax){av.sort(function(aA,aB){var ay=Math.abs(aA.left+aA.width/2-aw)+Math.abs(aA.top+aA.height/2-ax),az=Math.abs(aB.left+aB.width/2-aw)+Math.abs(aB.top+aB.height/2-ax);return ay-az})}function U(aB,aA){var av=aA.sel.tileSize,ax=aA.tileKey,aw=Math.ceil(av*ax.res/aB.res),ay=Math.floor(aB.prjToDspX(ax.scaledX*ax.res)-aB.x),az=Math.floor(aB.prjToDspY(ax.scaledY*ax.res)-aB.y);aA.setBounds(ay,az,aw,aw)}function e(av){av=av||{};this.tileSize=av.tileSize||256;this.srcSpec=av.tileSrc||"";this.pending={}}e.prototype={toString:function(){return this.srcSpec},_sched:function(ax){var av=this,ay=ax.tile.tileKey.id,aw=ax.img;aw.onload=function(){ax.loaded=true;az();if(ax.tile){ax.tile.update(aw)}};aw.onerror=function(){az()};function az(){ax.time=ab()-ax.time;delete av.pending[ay]}av.pending[ay]=ax;aw.src=ax.src},loadTile:function(aw){var av={tile:aw,src:this.resolveSrc(aw.tileKey),img:document.createElement("img"),loaded:false,time:ab()};this._sched(av)},destroyTile:function(aw){var ax=aw.tileKey.id;var av=this.pending[ax];if(av&&av.tile===aw){delete this.pending[ax];av.img.src="data:image/png,"}},destroyDrawable:function(av,aw){},resolveSrc:function(av){return this.srcSpec.replace(/\$\{([A-Za-z]+)(\:([^\}]*))?\}/g,function(ay,az,ax,aw){if(az==="quadkey"){return N(av.tileX,av.tileY,av.level)}else{if(az==="modulo"){aw=aw.split(/\,/);return aw[av.tileX%aw.length]}else{return av[az]}}})},select:function(aw,aF,ay,aN,aA,aO){var aH=this.tileSize,aG=aw.PRJ_EXTENT,aL=aw.XINVERTED,aM=aw.YINVERTED,aP=Math.round(aw.toLevel(aF)),aJ=aw.fromLevel(aP),aB,aC;ay/=aJ;aN/=aJ;aA/=aJ;aO/=aJ;if(aM){aC=aG.maxy/aJ;aN=aC-aN;aO=aC-aO}else{aC=aG.miny/aJ;aN=aN-aC;aO=aO-aC}if(aL){aB=aG.maxx/aJ;ay=aB-ay;aA=aB-aA}else{aB=aG.minx/aJ;ay=ay-aB;aA=aA-aB}var ax=Math.floor(Math.min(ay,aA)/aH),az=Math.floor(Math.min(aN,aO)/aH),aQ=Math.floor(Math.max(ay,aA)/aH),aR=Math.floor(Math.max(aO,aO)/aH),aD,aE,aI,aK,av=[];for(aE=az;aE<=aR;aE++){if(aM){aK=aC-aE*aH}else{aK=aC+aE*aH}for(aD=ax;aD<=aQ;aD++){if(aL){aI=aB-aD*aH}else{aI=aB+aD*aH}av.push(new aq(aP,aD,aE,aJ,aI,aK,aH))}}return av}};function aq(ax,ay,az,aB,aA,av,aw){this.id=ay+","+az+"@"+ax;this.level=ax;this.tileX=ay;this.tileY=az;this.res=aB;this.scaledX=aA;this.scaledY=av;this.size=aw}function b(aw,av){this.sel=aw;this.tileKey=av;this.drawable=null;this.parent=null;this.left=null;this.top=null;this.width=null;this.height=null;this.mark=false;this.temporary=false;this.loading=false}b.prototype={_commitBounds:function(av){av.style.position="absolute";av.style.left=this.left+"px";av.style.top=this.top+"px";av.style.width=this.width+"px";av.style.height=this.height+"px"},update:function(aw){var av=this.drawable;this.drawable=aw;aw.setAttribute("tileid",this.tileKey.id);if(this.parent){this._commitBounds(aw);if(av){this.parent.replaceChild(aw,av)}else{this.parent.appendChild(aw)}}if(av){this.sel.destroyDrawable(this,av)}},setBounds:function(ax,ay,az,aw){var av=this.drawable;this.left=parseInt(ax);this.top=parseInt(ay);this.width=parseInt(az);this.height=parseInt(aw);if(av){this._commitBounds(av)}},attach:function(av){var aw=this.drawable;if(this.parent&&av!==this.parent){this.detach()}this.parent=av;if(aw){this._commitBounds(aw);if(!aw.parentNode){av.appendChild(aw)}}},detach:function(){var av=this.drawable;this.parent=null;if(av&&av.parentNode){av.parentNode.removeChild(av)}},dispose:function(){this.detach();if(this.drawable){this.sel.destroyDrawable(this,this.drawable);this.drawable=null}this.sel.destroyTile(this)},generatePreview:function(av){var aw=this,ax=null;av.intersect(aw,function(ay){if(!ax){try{ax=new q(aw)}catch(az){}}if(ax){ax.add(ay)}});if(ax){aw.update(ax.drawable)}}};function q(ax){var av=document.createElement("canvas"),aw;av.width=ax.width;av.height=ax.height;aw=av.getContext("2d");this.drawable=av;this.add=function(aK){var ay=aK.left-ax.left,az=aK.top-ax.top,aC=0,aD=0,aA,aF,aH,aB=aK.width,aG=aK.height,aI=aK.tileKey.size/aK.width,aJ=aK.tileKey.size/aK.height;if(ay<0){aC=-ay;ay=0;aB-=aC}if(az<0){aD=-az;az=0;aG-=aD}aH=ay+aB-ax.width;if(aH>=0){aB-=aH}aH=az+aG-ax.height;if(aH>=0){aG-=aH}aC*=aI;aD*=aJ;aA=aB*aI;aF=aG*aJ;try{aw.drawImage(aK.drawable,aC,aD,aA,aF,ay,az,aB,aG)}catch(aE){}}}function P(){this._c={}}P.prototype={each:function(ax){var av=this._c,aw;for(aw in av){if(av.hasOwnProperty(aw)){ax(av[aw])}}},resetMarks:function(){this.each(function(av){av.mark=false})},get:function(av){return this._c[av.id]},add:function(av){var ax=av.tileKey.id,ay=this._c;var aw=ay[ax];if(aw){aw.dispose()}ay[ax]=av},move:function(az,av){var ax=az.id,ay=this._c,aw=ay[ax];if(aw){delete ay[ax];av.add(aw)}return aw},sweep:function(aA,aw){var ax=this._c,az=[],av,ay;for(av in ax){if(ax.hasOwnProperty(av)){ay=ax[av];if(!ay.mark){if(aA){aA.add(ay)}else{ay.dispose()}if(aw){aw(ay)}az.push(av)}}}for(av=0;av<az.length;av++){delete ax[az[av]]}},clear:function(){var ax=this._c,av=[],aw,ay;for(aw in ax){if(ax.hasOwnProperty(aw)){ay=ax[aw];ay.dispose()}}this._c={}},intersect:function(ay,aw){var aA=this._c,aD,aC,av=ay.left,ax=ay.top,az=av+ay.width,aB=ax+ay.height;for(aD in aA){if(aA.hasOwnProperty(aD)){aC=aA[aD];if(aC.drawable&&!(aC.left>=az||(aC.left+aC.width)<av||aC.top>=aB||(aC.top+aC.height)<ax)){aw(aC)}}}}};nanomaps.CartesianTileSelector=e;nanomaps.TileLayer=r;var M=0,K=1,S=2,f=280,t=10,J=1000,aa=280;function g(av){this.type=av;this.handled=false}function m(ax){function av(aR){ax.dispatchMotionEvent(aR)}var aD,aJ;function aQ(aS){var aR=ax.elements.document;if(aS&&!aJ){au(aR,"mouseup",aK);au(aR,"mousemove",aK);aJ=true}else{if(!aS&&aJ){k(aR,"mouseup",aK);k(aR,"mousemove",aK);aJ=false}}}function aE(aR,aS){aH();aD={b:aR.button,s:M,cnt:0,cs:aS,cl:aS,t:0,ti:null}}function aG(){setTimeout(function(){if(aD&&aD.s===S){aD.ti=null;az();aH()}},f)}function aI(){if(aD&&aD.ti){clearTimeout(aD.ti)}}function az(){var aR=new g("click");aR.button=aD.b;aR.count=aD.cnt;aR.x=aD.cs.x;aR.y=aD.cs.y;av(aR)}function aH(){aI();aD=null}function aK(aT){if(!Q(aT)){return}aj(aT);var aS=ax.eventToContainer(aT),aR;switch(aT.type){case"mousemove":if(aD.s===M||aD.s===K){aD.s=K;aR=new g("drag");aR.button=aD.b;aR.x=aS.x;aR.y=aS.y;if(!aD.cl){aD.cl=aD.cs}aR.deltaX=aD.cl.x-aS.x;aR.deltaY=aD.cl.y-aS.y;aD.cl=aS;av(aR)}break;case"mousedown":if(aD&&aD.s===S){if((ab()-aD.t)>f){az();aE(aT,aS)}else{aD.s=M;aI()}}else{aE(aT,aS)}aQ(true);break;case"mouseup":aQ(false);aD.cnt++;if(aD.s===M){aD.s=S;aD.t=ab();aG()}else{aH()}break}}function aB(aT){aj(aT);aH();aQ(false);var aV,aS=10,aR=ax.eventToContainer(aT),aU=new g("scroll");if(aT.wheelDelta){aV=aT.wheelDelta/120}else{if(aT.delta){aV=-aT.delta/3}else{aV=-aT.detail/3}}aV/=aS;if(aV>2){aV=2}else{if(aV<-2){aV=-2}}aU.x=aR.x;aU.y=aR.y;aU.deltaZoom=aV/aS;av(aU)}var aP;function aF(){aL();aP.ti=setTimeout(function(){aP.ti=null;aw();aN()},aa)}function aC(){aL();aP.ti=setTimeout(function(){if(!aP||aP.s!==M||aP.t.length!==1){return}var aR=new g("longtap");aR.button=0;aR.x=aP.t[0].x;aR.y=aP.t[0].y;aR.count=1;av(aR);if(aR.handled){aN()}},J)}function aL(){if(aP){if(aP.ti){clearTimeout(aP.ti)}aP.ti=null}}function aN(){aL();aP=null}function aw(){var aR=new g("click");aR.button=0;aR.count=aP.cnt;aR.x=aP.tapX;aR.y=aP.tapY;av(aR)}function aO(aR){var aS=[];if(aR){for(i=0;i<aR.length;i++){touch=aR[i];aS.push(ax.eventToContainer(touch))}}return aS}function ay(aS,aT){var aR=new g("drag");aR.button=0;aR.x=aS.x;aR.y=aS.y;aR.deltaX=aT.x-aS.x;aR.deltaY=aT.y-aS.y;av(aR)}function aA(aW,aY,aU,aV){var a0=new g("pinch"),aR=(aW.x+aY.x)/2,aT=(aW.y+aY.y)/2,aX=(aU.x+aV.x)/2,aZ=(aU.y+aV.y)/2,a2=aW.x-aY.x,a3=aW.y-aY.y,a4=aU.x-aV.x,a5=aU.y-aV.y,a1=Math.sqrt(a2*a2+a3*a3),aS=Math.sqrt(a4*a4+a5*a5);a0.button=0;a0.x=aR;a0.y=aT;a0.deltaX=aX-aR;a0.deltaY=aZ-aT;a0.deltaZoom=Math.log(a1/aS)*1.5;av(a0)}function aM(aT){var aR=aT.type,aS;aj(aT);aS=aO(aT.touches);if(aR==="touchstart"){if(aP&&aP.s===S){if((ab()-aP.te)>aa){touchDispatch();aN()}else{if(aS.length===1){aP.s=M;aP.t=aS;aL();return}}}if(!aP){aP={s:M,t:aS,mt:false,te:0,ts:ab(),ti:null,cnt:0};aC()}else{if(aS.length>1){aP.mt=true}aP.t=aS}return}if(!aP){return}switch(aT.type){case"touchmove":if(aS.length===1){if(aP.s===K||Math.abs(aS[0].x-aP.t[0].x)>t||Math.abs(aS[0].y-aP.t[0].y)>t){aL();if(aP.s===S){touchDispatch();aP.cnt=0}aP.s=K;ay(aS[0],aP.t[0]);aP.t=aS}}else{if(aS.length>1){aP.s=K;aA(aS[0],aS[1],aP.t[0],aP.t[1]);aP.t=aS}}break;case"touchend":if(!aP.mt||aS.length===0){if(aP.s===M){aP.cnt++;aP.s=S;aP.tapX=aP.t[0].x;aP.tapY=aP.t[0].y;aP.te=ab();aF()}else{aN()}}else{aP.t=aS}break;case"touchcancel":aN();break}}this.listen=function(aS,aY,aT){var aW=ax.elements,aU=aW.event,aV=aW.parent,aR=["touchstart","touchend","touchmove","touchcancel"],aX;if(aS){au(aU,"mousedown",aK)}if(aT){au(aU,"DOMMouseScroll",aB);au(aU,"mousewheel",aB)}if(aY&&aU.addEventListener){for(aX=0;aX<aR.length;aX++){aU.addEventListener(aR[aX],aM,true)}}}}X.advise("initialize","after",function(aw){var av=new m(this);this.motionController=av;av.listen(!aw.noClick,!aw.noTouch,!aw.noWheel);this.elements.event.style.cursor="move"});X.dispatchMotionEvent=function(av){var aw="motion."+av.type;this.emit(aw,av);if(!av.handled){this.handleMotionEvent(av)}};X.handleMotionEvent=function(av){if(av.handled){return}var ax=av.type,aw;if(ax==="drag"||ax==="pinch"){this.begin();this.moveBy(av.deltaX,-av.deltaY);aw=Number(av.deltaZoom);if(!isNaN(aw)){this.setZoom(this.getZoom()+aw,av.x,av.y)}this.commit();av.handled=true}else{if(ax==="scroll"){this.setZoom(this.getZoom()+av.deltaZoom,av.x,av.y);av.handled=true}else{if(ax==="click"&&av.count===2){this.begin();this.zoomIn(av.x,av.y);this.commit(true);av.handled=true}}}};function O(av,aw){if(aw[0]==="/"||aw.search(/^http(s)?\:/)>=0){return aw}if(av.match(/\/$/)){return av+aw}else{return av+"/"+aw}}function a(av){var ay=av.lastIndexOf("/"),ax=(ay>=0?av.substring(ay+1):av),aw=ax.match(/^([^_\-\.]+)/);return aw?aw[0]:av}function D(av){this.settings=new V(av);this.element=null;this.children=null}D.Settings={src:"orb_blue.png",baseUri:"",location:null,classSuffix:"",extraClasses:""};D.prototype={defaultLayer:"overlay",setLocation:function(ax){ax=d.from(ax);var ay=this.settings,av=this.element,aw=this.owner;ay.location=ax;if(av){if(ax){av.geo={latitude:ax.lat(),longitude:ax.lng()}}else{av.geo=null}if(aw&&av.parentNode){aw.update(av)}}},getElement:function(aw){this.owner=aw;if(this.element){return this.element}var ax=aw.elements.document,av=ax.createElement("div"),ay=ax.createElement("img");av.appendChild(ay);this.element=av;this.children={fg:ay};this._config();return av},_config:function(){var ax=this.settings,aA=ax.location,az=this.element,ay=this.children.fg,aw,av;aw=O(ax.baseUri||"",ax.src||"");av=ax.classSuffix||a(aw);az.className="nmim nmim-"+av+" "+ax.extraClasses;if(aA){az.geo={latitude:aA.lat()||NaN,longitude:aA.lng()||NaN}}else{az.geo=null}ay.className="nmim-fg";ay.setAttribute("src",aw||null)}};function V(av){if(av){for(var aw in av){if(av.hasOwnProperty(aw)){this[aw]=av[aw]}}}}V.prototype=D.Settings;ae.ImgMarker=D;var ap="http://www.w3.org/2000/svg";function ai(av){try{return document.createElementNS(ap,av)}catch(ax){var aw=document.createElement("svgdummy");if(!aw.style){aw.style={}}}}function A(av){av=this.settings=av||{};var aw=ai("svg");aw.setAttribute("class",av.className||"");aw.mapeer=this;this.canvas=aw}A.prototype={unmanaged:false,defaultLayer:"shadow",getElement:function(av){this.owner=av;return this.canvas},mareset:function(av,aw){},invalidate:function(){var aw=this.owner,av=this.canvas;if(aw&&av.parentNode){this.mareset(aw,av)}}};j(A,E);function an(aw){A.call(this,aw);var av=ai("ellipse");this.canvas.appendChild(av);this.ellipse=av}an.prototype={mareset:function(aJ,aF){var aG=this.ellipse,aD=this.settings,aH,aI,aw=aD.unit||"px",aK=aD.longitude,ay=aD.latitude,aE,aA,aB,aC,av,ax,az;if("radius" in aD){aH=aI=ad(aJ,aD.radius||0,aw)}else{aH=ad(aJ,aD.rx||0,aw);aI=ac(aJ,aD.ry||0,aw)}aE=ao(aH*2+20);aA=ao(aI*2+20);aB=Math.round(aE/2);aC=Math.round(aA/2);aG.setAttribute("cx",aB);aG.setAttribute("cy",aC);aG.setAttribute("rx",aH);aG.setAttribute("ry",aI);av=aJ.globalToXY(aD);if(av){ax=av.x()-aB;az=av.y()-aC;aF.style.left=ax+"px";aF.style.top=az+"px";aF.style.width=aE+"px";aF.style.height=aA+"px";aF.style.display="block"}else{aF.style.display="none"}}};j(an,A);function ao(av){av=Math.ceil(av);if((av%2)!==1){av++}return av}function ad(ay,ax,av){var aw=ay.mapState.res;switch(av){case"px":return ax;case"m":return ax/aw;default:return 0}}function ac(ay,ax,av){var aw=ay.mapState.res;switch(av){case"px":return ax;case"m":return ax/aw;default:return 0}}ae.SvgMarker=A;ae.EllipseMarker=an})(window);